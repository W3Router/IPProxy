# 数据流设计文档

## 一、直接数据库操作

### 1. 代理商管理
#### 读取操作
- 代理商列表展示
  * 代理商基本信息（账号、状态、创建时间等）
  * 代理商余额
  * 备注信息
  * 所属关系

#### 写入操作
- 代理商账户管理
  * 新增代理商
  * 修改密码
  * 更新状态（启用/禁用）
  * 更新备注
- 代理商额度管理（同步写入）
  * 记录充值操作
  * 记录额度调整

#### API读取
- 代理用户信息
  * 获取代理用户列表
  * 获取代理用户详情
  * 获取代理用户认证状态
  * 获取代理用户额度信息

#### API写入
- 代理用户管理
  * 创建代理用户（/api/open/app/proxy/user/v2）
    - 参数：
      * username: 代理用户名
      * password: 代理用户密码
      * remark: 备注信息
      * flowLimit: 流量限制
    - 返回：
      * code: 状态码
      * msg: 返回信息
      * data: 用户信息
  * 修改代理用户信息
  * 设置代理用户状态
  * 设置代理用户额度

#### 同步到数据库
- 代理用户数据
  * 保存代理用户基本信息
  * 记录代理用户操作日志
  * 更新代理用户状态
  * 更新代理用户额度

### 2. 用户管理
#### 读取操作
- 用户列表展示
  * 用户基本信息
  * 所属代理商
  * 状态信息
  * 备注信息

#### 写入操作
- 用户账户管理
  * 新增用户
  * 修改密码
  * 更新状态
  * 更新备注

### 3. 订单记录
#### 读取操作
- 订单列表查询
  * 代理商订单
  * 用户动态订单
  * 用户静态订单
- 订单统计数据

#### 写入操作
- 订单状态更新
- 订单关联信息更新

## 二、API交互后同步

### 1. 动态资源操作
#### API读取
- 产品信息
  * 获取动态资源产品列表
  * 获取产品价格信息
  * 获取产品配置信息
  * 获取可用区域信息（/api/open/app/product/area/v2）
  * 获取动态代理区域列表

- 资源使用情况
  * 查询动态资源使用量
  * 查询带宽使用情况
  * 查询计费情况
  * 获取资源使用明细
  * 获取动态代理提取记录
  * 获取代理余额信息（/api/open/app/proxy/info/v2）
  * 获取流量使用记录（/api/open/app/proxy/flow/use/log/v2）

- 实例管理
  * 查询实例状态
  * 获取实例配置信息
  * 获取实例使用统计
  * 获取实例错误日志
  * 获取代理用户信息

#### API写入
- 资源购买
  * 创建动态资源实例
  * 更新资源配置
  * 续费资源实例
  * 释放资源实例
  * 动态代理流量回收（/api/open/app/proxy/return/v2）

- 实例操作
  * 启动/停止实例
  * 重置实例配置
  * 更新实例参数
  * 设置带宽限制
  * API提取代理（/api/open/app/proxy/draw/api/v2）
  * 账密提取代理（/api/open/app/proxy/draw/pwd/v2）
  * 创建/修改代理用户（/api/open/app/proxy/user/v2）

- IP白名单管理
  * 添加IP白名单（/api/open/app/proxy/addIpWhiteList/v2）
  * 删除IP白名单（/api/open/app/proxy/delIpWhiteList/v2）

### 2. 静态资源操作
#### API读取
- 产品信息
  * 获取静态IP产品列表
  * 获取IP池状态信息
  * 获取区域可用性信息
  * 获取价格配置信息
  * 查询指定IP可用信息（/api/open/app/assign/ip/info/v2）

- 资源状态
  * 查询静态IP使用状态
  * 获取IP详细信息（含端口/认证信息）
  * 查询IP可用性
  * 获取IP使用统计
  * 获取IP质量报告

#### API写入
- 资源管理
  * 申请静态IP资源
  * 释放静态IP资源
  * 更新IP配置信息
  * 续费IP资源（/api/open/app/instance/renew/v2）
  * 指定IP开通代理（/api/open/app/instance/open/assign/ip/v2）
  * 释放代理（/api/open/app/instance/release/v2）

### 3. 订单操作
#### API交互
- 订单创建
  * 创建动态资源订单
  * 创建静态资源订单（/api/open/app/instance/open/v2）
  * 创建续费订单
  * 创建升级订单

- 订单管理
  * 查询订单状态
  * 获取订单信息（/api/open/app/order/v2）
  * 取消未支付订单
  * 申请订单退款

### 4. 回调处理
- 订单回调（type=order）
  * 订单创建回调（op=1）
  * 订单续费回调（op=2）
  * 订单释放回调（op=3）

- 实例回调（type=instance）
  * 实例状态变更
  * 实例配置更新

- 产品回调（type=product）
  * 产品信息变更
  * 产品价格更新

### 5. 用量统计
#### API读取
- 资源统计
  * 获取总体使用量
  * 获取计费统计
  * 获取带宽统计
  * 获取异常统计

- 账单信息
  * 获取账单明细
  * 获取消费记录
  * 获取计费规则
  * 获取价格变动

#### 同步到数据库
- 统计记录
  * 更新使用量统计
  * 记录计费数据
  * 更新账单信息
  * 记录异常情况

### 6. 系统配置
#### API读取
- 获取系统参数
- 获取产品配置
- 获取计费规则
- 获取限制策略

#### API写入
- 更新系统配置
- 设置告警规则
- 配置自动续费
- 设置资源限制

## 三、回调处理

### 1. 订单回调
- 接收回调信息
- 更新数据库订单状态
- 更新相关统计数据

### 2. 实例回调
- 接收实例状态变更
- 更新数据库实例信息
- 触发相关业务处理

### 3. 产品回调
- 接收产品变动信息
- 更新产品数据
- 同步展示信息

## 四、数据同步策略

### 1. 实时同步
- 订单状态
- 资源使用情况
- 账户额度变更

### 2. 定时同步
- 统计数据
- 资源使用报表
- 产品信息更新

### 3. 触发同步
- 异常状态处理
- 手动刷新处理
- 特定操作触发

## 五、异常处理

### 1. API异常
- 请求超时处理
- 数据不一致处理
- 重试机制

### 2. 数据库异常
- 事务回滚
- 数据恢复
- 日志记录

### 3. 同步异常
- 重新同步
- 数据校验
- 手动修复

## 六、数据一致性保证

### 1. 操作原子性
- 使用事务确保操作完整性
- 保证关联数据同步更新
- 异常时自动回滚

### 2. 状态同步
- 定期校验数据一致性
- 自动修复数据差异
- 记录同步日志

### 3. 并发控制
- 使用锁机制
- 版本控制
- 并发队列处理 